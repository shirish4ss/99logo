<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | 99logo [DEBUG]</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .text-gradient {
            background: linear-gradient(to right, var(--accent-color, #818cf8), #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        
        :root { --accent-color: #6366f1; }
        .accent-bg { background-color: var(--accent-color); }
        .accent-text { color: var(--accent-color); }
    </style>
</head>
<body class="bg-[#0f172a] text-white">

    <!-- DEBUG PANEL (Always visible in bottom-right) -->
    <div id="debugPanel" class="fixed bottom-4 right-4 bg-black/90 border border-green-500 text-green-400 p-4 rounded-xl z-[999] max-w-md text-xs font-mono max-h-96 overflow-y-auto">
        <div class="flex justify-between items-center mb-2">
            <h4 class="font-bold text-white">üîç DEBUG LOG</h4>
            <button onclick="document.getElementById('debugPanel').classList.add('hidden')" class="text-red-400">√ó</button>
        </div>
        <div id="debugLog"></div>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="fixed inset-0 bg-[#0f172a] z-[90] flex items-center justify-center">
        <div class="text-center max-w-md mx-auto p-8">
            <i class="fas fa-circle-notch fa-spin text-4xl text-indigo-500 mb-4"></i>
            <p class="text-gray-400 text-sm mb-8">Initializing Dashboard...</p>
            
            <!-- MANUAL LOGIN OPTION -->
            <div class="glass p-6 rounded-xl border border-yellow-500/30">
                <h3 class="text-lg font-bold mb-4 text-yellow-400">‚ö†Ô∏è Taking Too Long?</h3>
                <p class="text-xs text-gray-400 mb-4">If stuck, manually set your user:</p>
                
                <select id="manualRole" class="w-full bg-black/60 border border-gray-600 rounded p-2 text-sm mb-3">
                    <option value="admin">Admin</option>
                    <option value="client">Client</option>
                </select>
                
                <input type="text" id="manualName" placeholder="Your Name" class="w-full bg-black/60 border border-gray-600 rounded p-2 text-sm mb-3">
                <input type="email" id="manualEmail" placeholder="Your Email" class="w-full bg-black/60 border border-gray-600 rounded p-2 text-sm mb-3">
                
                <button onclick="manualLogin()" class="w-full bg-green-600 hover:bg-green-500 py-2 rounded font-bold text-sm">
                    Force Login & Continue
                </button>
            </div>
            
            <button onclick="logout()" class="mt-4 text-xs text-red-500 underline">Clear & Logout</button>
        </div>
    </div>

    <nav class="glass border-b border-gray-800 sticky top-0 z-50">
        <div class="max-w-[1600px] mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold">99logo<span class="text-gradient">Dashboard</span></h1>
            <div class="flex items-center gap-4">
                <span id="userDisplay" class="text-gray-400 text-sm">Loading...</span>
                <button onclick="logout()" class="text-red-400 text-sm font-semibold border border-red-400/30 px-3 py-1 rounded-lg">Logout</button>
            </div>
        </div>
    </nav>

    <div class="max-w-[1600px] mx-auto px-4 py-8">
        
        <!-- ADMIN VIEW -->
        <div id="adminView" class="hidden">
            <h2 class="text-3xl font-bold mb-8">Admin Dashboard</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="glass p-6 rounded-xl border-l-4 border-green-500">
                    <h3 class="text-gray-400 text-xs uppercase">Total Orders</h3>
                    <p class="text-3xl font-bold" id="stat-total">0</p>
                </div>
                <div class="glass p-6 rounded-xl border-l-4 border-yellow-500">
                    <h3 class="text-gray-400 text-xs uppercase">In Progress</h3>
                    <p class="text-3xl font-bold" id="stat-pending">0</p>
                </div>
                <div class="glass p-6 rounded-xl border-l-4 border-red-500">
                    <h3 class="text-gray-400 text-xs uppercase">Unpaid</h3>
                    <p class="text-3xl font-bold" id="stat-unpaid">0</p>
                </div>
                <div class="glass p-6 rounded-xl border-l-4 border-indigo-500">
                    <h3 class="text-gray-400 text-xs uppercase">Completed</h3>
                    <p class="text-3xl font-bold" id="stat-completed">0</p>
                </div>
            </div>

            <div class="glass p-6 rounded-xl">
                <h3 class="text-xl font-bold mb-4">Orders List</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-black/40 text-gray-400 text-xs uppercase">
                            <tr>
                                <th class="px-4 py-3">ID</th>
                                <th class="px-4 py-3">Client</th>
                                <th class="px-4 py-3">Brand</th>
                                <th class="px-4 py-3">Status</th>
                                <th class="px-4 py-3">Date</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <tr><td colspan="5" class="text-center py-8 text-gray-500">Loading orders...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CLIENT VIEW -->
        <div id="clientView" class="hidden max-w-4xl mx-auto">
            <h2 class="text-3xl font-bold mb-8">Your Orders</h2>
            <div id="clientOrdersContainer" class="space-y-6">
                <div class="glass p-6 rounded-2xl text-center text-gray-400">
                    <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                    <p>Loading your orders...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DEBUG LOGGING
        const debugLog = [];
        function log(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.push(`[${timestamp}] ${msg}`);
            
            const logEl = document.getElementById('debugLog');
            const colorClass = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-blue-400';
            logEl.innerHTML += `<div class="${colorClass}">[${timestamp}] ${msg}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${msg}`);
        }

        // CONFIG
        const supabaseUrl = 'https://xwqitpteemdvrycpcxgo.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh3cWl0cHRlZW1kdnJ5Y3BjeGdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzczNjQ2MzEsImV4cCI6MjA1Mjk0MDYzMX0.UiLZoLk6jpNl4RnkFdmZWF0s5UyevyK1xKZxnUjVqR4';
        
        let supabase;
        let globalOrders = [];

        // MANUAL LOGIN FUNCTION
        function manualLogin() {
            log('Manual login initiated...', 'info');
            const role = document.getElementById('manualRole').value;
            const name = document.getElementById('manualName').value || 'Test User';
            const email = document.getElementById('manualEmail').value || 'test@example.com';
            
            const user = { role, name, email };
            localStorage.setItem('currentUser', JSON.stringify(user));
            log(`User set: ${name} (${role})`, 'success');
            
            location.reload();
        }

        // HIDE LOADER
        function hideLoader() {
            log('Hiding loader...', 'info');
            const loader = document.getElementById('loadingOverlay');
            if(loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 300);
            }
        }

        // INIT
        window.addEventListener('DOMContentLoaded', async () => {
            log('üöÄ Dashboard starting...', 'info');
            
            try {
                // STEP 1: Check localStorage
                log('Step 1: Checking localStorage...', 'info');
                const userStr = localStorage.getItem('currentUser');
                log(`LocalStorage value: ${userStr ? 'Found' : 'NOT FOUND'}`, userStr ? 'success' : 'error');
                
                if (!userStr || userStr === "null" || userStr === "undefined") {
                    log('‚ùå No valid user found - need login', 'error');
                    log('Please use manual login or go back to login page', 'error');
                    return; // Don't redirect, show manual login
                }
                
                // STEP 2: Parse User
                log('Step 2: Parsing user data...', 'info');
                let user;
                try {
                    user = JSON.parse(userStr);
                    log(`‚úÖ User parsed: ${JSON.stringify(user)}`, 'success');
                } catch(e) {
                    log(`‚ùå Parse error: ${e.message}`, 'error');
                    localStorage.removeItem('currentUser');
                    return;
                }

                // STEP 3: Update UI
                log('Step 3: Updating UI...', 'info');
                const userDisplay = document.getElementById('userDisplay');
                if(userDisplay) {
                    userDisplay.innerText = `Welcome, ${user.name || user.email || 'User'}`;
                    log('‚úÖ Username displayed', 'success');
                }

                // STEP 4: Show appropriate view
                log('Step 4: Determining user role...', 'info');
                const role = user.role ? user.role.toLowerCase() : 'client';
                log(`Role detected: ${role}`, 'info');
                
                const adminView = document.getElementById('adminView');
                const clientView = document.getElementById('clientView');

                if (role === 'admin') {
                    log('Showing ADMIN view', 'success');
                    adminView.classList.remove('hidden');
                    clientView.classList.add('hidden');
                } else {
                    log('Showing CLIENT view', 'success');
                    adminView.classList.add('hidden');
                    clientView.classList.remove('hidden');
                }
                
                // STEP 5: Hide loader
                log('Step 5: Hiding loader...', 'success');
                hideLoader();

                // STEP 6: Initialize Supabase
                log('Step 6: Connecting to Supabase...', 'info');
                try {
                    if (typeof window.supabase === 'undefined') {
                        throw new Error('Supabase library not loaded');
                    }
                    
                    supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                    log('‚úÖ Supabase client created', 'success');
                    
                    // STEP 7: Fetch data
                    log('Step 7: Fetching data...', 'info');
                    if (role === 'admin') {
                        await fetchAdminData();
                    } else {
                        await fetchClientData(user.email);
                    }
                    
                } catch (supaError) {
                    log(`‚ùå Supabase error: ${supaError.message}`, 'error');
                    showDemoData(role);
                }

            } catch (err) {
                log(`‚ùå FATAL ERROR: ${err.message}`, 'error');
                log(`Stack: ${err.stack}`, 'error');
            }
        });

        // FETCH ADMIN DATA
        async function fetchAdminData() {
            try {
                log('Fetching admin orders from database...', 'info');
                const { data: orders, error } = await supabase.from('orders').select('*');
                
                if (error) {
                    log(`Database error: ${error.message}`, 'error');
                    showDemoData('admin');
                    return;
                }
                
                log(`‚úÖ Loaded ${orders ? orders.length : 0} orders`, 'success');
                globalOrders = orders || [];
                updateAdminUI();
                
            } catch(err) {
                log(`Fetch error: ${err.message}`, 'error');
                showDemoData('admin');
            }
        }

        // UPDATE ADMIN UI
        function updateAdminUI() {
            log('Updating admin UI...', 'info');
            
            // Stats
            document.getElementById('stat-total').innerText = globalOrders.length;
            document.getElementById('stat-pending').innerText = globalOrders.filter(o => o.status === 'In Progress').length;
            document.getElementById('stat-unpaid').innerText = globalOrders.filter(o => o.status === 'Unconfirmed').length;
            document.getElementById('stat-completed').innerText = globalOrders.filter(o => o.status === 'Completed').length;
            
            // Table
            const tbody = document.getElementById('ordersTableBody');
            if(tbody) {
                if(globalOrders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No orders in database</td></tr>';
                } else {
                    tbody.innerHTML = globalOrders.map(o => `
                        <tr class="border-b border-gray-800 hover:bg-white/5">
                            <td class="px-4 py-3 font-mono text-xs">${o.id}</td>
                            <td class="px-4 py-3">${o.clientName || 'N/A'}</td>
                            <td class="px-4 py-3">${o.brandName || 'N/A'}</td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 rounded text-xs ${
                                    o.status === 'Completed' ? 'bg-green-900 text-green-300' :
                                    o.status === 'In Progress' ? 'bg-yellow-900 text-yellow-300' :
                                    'bg-red-900 text-red-300'
                                }">${o.status || 'Pending'}</span>
                            </td>
                            <td class="px-4 py-3 text-xs text-gray-500">${o.date || '-'}</td>
                        </tr>
                    `).join('');
                }
            }
            
            log('‚úÖ Admin UI updated', 'success');
        }

        // FETCH CLIENT DATA
        async function fetchClientData(email) {
            try {
                log(`Fetching orders for: ${email}`, 'info');
                const { data, error } = await supabase.from('orders').select('*').eq('userEmail', email);
                
                if(error) {
                    log(`Database error: ${error.message}`, 'error');
                    showDemoData('client');
                    return;
                }
                
                log(`‚úÖ Found ${data ? data.length : 0} orders`, 'success');
                
                const container = document.getElementById('clientOrdersContainer');
                if(container && data) {
                    if(data.length === 0) {
                        container.innerHTML = `
                            <div class="glass p-8 rounded-2xl text-center">
                                <i class="fas fa-inbox text-5xl text-gray-600 mb-4"></i>
                                <h3 class="text-xl font-bold mb-2">No Orders Yet</h3>
                                <p class="text-gray-400 text-sm">Place your first order to get started!</p>
                            </div>
                        `;
                    } else {
                        container.innerHTML = data.map(o => `
                            <div class="glass p-6 rounded-2xl border border-white/10">
                                <div class="flex justify-between items-center mb-4">
                                    <div>
                                        <h3 class="text-xl font-bold">${o.brandName || 'Your Logo'}</h3>
                                        <p class="text-xs text-gray-500">Order ID: ${o.id}</p>
                                    </div>
                                    <span class="px-3 py-1 rounded text-xs font-bold ${
                                        o.status === 'Completed' ? 'bg-green-500/20 text-green-400' :
                                        o.status === 'In Progress' ? 'bg-yellow-500/20 text-yellow-400' :
                                        'bg-red-500/20 text-red-400'
                                    }">${o.status || 'Pending'}</span>
                                </div>
                                <div class="text-sm text-gray-400">
                                    <p><strong>Package:</strong> ${o.packageType || 'Standard'}</p>
                                    <p><strong>Niche:</strong> ${o.niche || 'N/A'}</p>
                                </div>
                            </div>
                        `).join('');
                    }
                }
                
            } catch(err) {
                log(`Client fetch error: ${err.message}`, 'error');
                showDemoData('client');
            }
        }

        // SHOW DEMO DATA
        function showDemoData(role) {
            log('‚ö†Ô∏è Showing demo data (database unavailable)', 'error');
            
            if(role === 'admin') {
                globalOrders = [
                    {id: 'DEMO-001', clientName: 'Demo Client', brandName: 'Demo Brand', status: 'In Progress', date: '2026-01-30'}
                ];
                updateAdminUI();
            } else {
                const container = document.getElementById('clientOrdersContainer');
                if(container) {
                    container.innerHTML = `
                        <div class="glass p-6 rounded-2xl border border-yellow-500/30">
                            <div class="flex items-center gap-3 mb-4">
                                <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl"></i>
                                <h3 class="text-xl font-bold">Demo Mode</h3>
                            </div>
                            <p class="text-sm text-gray-400">Unable to connect to database.</p>
                            <p class="text-xs text-gray-500 mt-2">Check console for details.</p>
                        </div>
                    `;
                }
            }
        }

        function logout() {
            log('Logging out...', 'info');
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
