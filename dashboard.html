<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | 99logo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- CSS for Glassmorphism and Transitions -->
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .text-gradient {
            background: linear-gradient(to right, var(--accent-color, #818cf8), #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active { display: flex; }
        
        /* New Styles for Features */
        :root { --accent-color: #6366f1; }
        .theme-pink { --accent-color: #ec4899; }
        .theme-blue { --accent-color: #3b82f6; }
        .theme-green { --accent-color: #22c55e; }
        
        .accent-bg { background-color: var(--accent-color); }
        .accent-text { color: var(--accent-color); }
        .accent-border { border-color: var(--accent-color); }

        /* Notification Badge Animation */
        @keyframes pulse-red {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .notification-dot { animation: pulse-red 2s infinite; }
        
        /* Flash Text Animation */
        @keyframes flash-fade {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .flash-text {
            animation: flash-fade 3s ease-in-out infinite;
        }
        
        /* Express Priority Badge */
        .express-badge {
            animation: pulse-red 1.5s infinite;
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        /* View Mode Styles */
        .view-mode-btn.active {
            background: var(--accent-color);
            color: white;
        }
        
        /* List View */
        .list-view .order-card {
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        
        /* Kanban View */
        .kanban-view {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }
        
        .kanban-column {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 1rem;
            padding: 1rem;
            min-height: 400px;
        }
    </style>
</head>
<body class="bg-[#0f172a] text-white transition-colors duration-300">

    <nav class="glass border-b border-gray-800 sticky top-0 z-50">
        <div class="max-w-[1600px] mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold">99logo<span class="text-gradient">Dashboard</span></h1>
            
            <div class="flex items-center gap-4">
                
                <!-- Notification Center -->
                <div class="relative group" id="notificationCenter">
                    <button class="text-gray-400 hover:text-white relative">
                        <i class="fas fa-bell text-lg"></i>
                        <span class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full notification-dot"></span>
                    </button>
                    <div class="absolute right-0 mt-2 w-64 glass rounded-xl hidden group-hover:block p-3 shadow-xl border border-gray-700">
                        <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">Notifications</h4>
                        <div class="space-y-2 text-xs max-h-64 overflow-y-auto" id="notifList">
                            <!-- Dynamic notifications -->
                        </div>
                    </div>
                </div>

                <button onclick="toggleSettingsModal()" class="text-gray-400 hover:text-white" id="settingsBtn">
                    <i class="fas fa-cog text-lg"></i>
                </button>

                <span id="userDisplay" class="text-gray-400 text-sm hidden md:block"></span>
                <button onclick="logout()" class="text-red-400 text-sm font-semibold border border-red-400/30 px-3 py-1 rounded-lg">Logout</button>
            </div>
        </div>
    </nav>

    <div class="max-w-[1600px] mx-auto px-4 py-8">
        
        <!-- ================= ADMIN AREA ================= -->
        <div id="adminView" class="hidden">
            
            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                <div class="glass p-5 rounded-xl border-l-4 border-green-500">
                    <h3 class="text-gray-400 text-xs">Total Earnings</h3>
                    <p class="text-2xl font-bold text-green-400" id="totalEarnings">‚Çπ0</p>
                </div>
                <div class="glass p-5 rounded-xl border-l-4 accent-border" style="border-left-width: 4px;">
                    <h3 class="text-gray-400 text-xs">Total Orders</h3>
                    <p class="text-2xl font-bold" id="stat-total">0</p>
                </div>
                <div class="glass p-5 rounded-xl border-l-4 border-yellow-500">
                    <h3 class="text-gray-400 text-xs">Working Now</h3>
                    <p class="text-2xl font-bold" id="stat-pending">0</p>
                </div>
                <div class="glass p-5 rounded-xl border-l-4 border-red-500">
                    <h3 class="text-gray-400 text-xs">Unpaid</h3>
                    <p class="text-2xl font-bold" id="stat-unpaid">0</p>
                </div>
                <button onclick="printInvoice()" class="glass p-5 rounded-xl border border-gray-700 hover:bg-white/5 flex flex-col justify-center items-center gap-2">
                    <i class="fas fa-file-invoice text-2xl text-purple-400"></i>
                    <span class="text-xs font-bold">Print Invoice</span>
                </button>
            </div>

            <!-- Layout -->
            <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
                
                <!-- Left Sidebar -->
                <div class="xl:col-span-1 space-y-4">
                    
                    <!-- Admin Sticky Notes -->
                    <div class="glass p-4 rounded-xl">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-sm font-bold flex items-center gap-2"><i class="fas fa-sticky-note text-yellow-400"></i> Sticky Notes</h3>
                            <button onclick="addStickyNote()" class="text-xs bg-white/10 px-2 py-1 rounded hover:bg-white/20">+</button>
                        </div>
                        <div id="stickyNotesContainer" class="space-y-2 max-h-40 overflow-y-auto">
                            <textarea class="w-full bg-yellow-500/10 border border-yellow-500/30 rounded p-2 text-xs text-yellow-100 placeholder-yellow-200/50 resize-none" rows="2" placeholder="Type a note..."></textarea>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold flex items-center gap-2 mt-6"><i class="fas fa-fire text-orange-500"></i> Priority Queue</h3>
                    <div id="priorityList" class="space-y-3">
                        <!-- JS Injected -->
                    </div>

                    <!-- Recent Activity Log -->
                    <div class="glass p-4 rounded-xl mt-6">
                        <h4 class="font-bold mb-3 text-sm text-gray-300">Recent Activity</h4>
                        <div class="space-y-3 relative border-l border-gray-700 ml-2 pl-4">
                            <div class="relative">
                                <div class="absolute -left-[21px] top-1 w-2.5 h-2.5 rounded-full bg-green-500"></div>
                                <p class="text-xs text-gray-400">Order #104 marked as <span class="text-green-400">Completed</span></p>
                                <span class="text-[10px] text-gray-600">10 mins ago</span>
                            </div>
                            <div class="relative">
                                <div class="absolute -left-[21px] top-1 w-2.5 h-2.5 rounded-full bg-indigo-500"></div>
                                <p class="text-xs text-gray-400">New order received <span class="text-indigo-400">#105</span></p>
                                <span class="text-[10px] text-gray-600">25 mins ago</span>
                            </div>
                            <div class="relative">
                                <div class="absolute -left-[21px] top-1 w-2.5 h-2.5 rounded-full bg-yellow-500"></div>
                                <p class="text-xs text-gray-400">Payment verified for <span class="text-yellow-400">#103</span></p>
                                <span class="text-[10px] text-gray-600">1 hour ago</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Area -->
                <div class="xl:col-span-3 space-y-6">
                    
                    <!-- View Mode Toggle -->
                    <div class="flex gap-2 justify-end mb-4">
                        <button onclick="setViewMode('grid')" class="view-mode-btn px-3 py-1 bg-white/10 rounded-lg text-xs hover:bg-white/20 active" id="gridBtn">
                            <i class="fas fa-th"></i> Grid
                        </button>
                        <button onclick="setViewMode('list')" class="view-mode-btn px-3 py-1 bg-white/10 rounded-lg text-xs hover:bg-white/20" id="listBtn">
                            <i class="fas fa-list"></i> List
                        </button>
                        <button onclick="setViewMode('kanban')" class="view-mode-btn px-3 py-1 bg-white/10 rounded-lg text-xs hover:bg-white/20" id="kanbanBtn">
                            <i class="fas fa-columns"></i> Kanban
                        </button>
                    </div>

                    <!-- Orders Container -->
                    <div id="ordersContainer">
                        <!-- Grid View (Default) -->
                        <div id="ordersGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                            <!-- JS Injects Here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= CLIENT AREA ================= -->
        <div id="clientView" class="hidden">
            
            <!-- Flash Messages -->
            <div class="glass p-6 rounded-2xl mb-6 border-l-4 border-indigo-500">
                <div class="flex items-start gap-4">
                    <i class="fas fa-info-circle text-2xl text-indigo-400 mt-1"></i>
                    <div class="flex-1">
                        <p class="text-sm text-gray-300 flash-text font-medium leading-relaxed" id="flashMessage">
                            Please be patient while we create your perfect design. Our working hours are 10 AM - 6 PM (Monday-Friday). We'll notify you once your design is ready!
                        </p>
                    </div>
                </div>
            </div>

            <!-- Progress Box -->
            <div id="clientProgress" class="glass p-8 rounded-2xl mb-8 hidden">
                <h3 class="text-xl font-bold mb-4 text-indigo-400">Project Progress</h3>
                <div class="relative h-6 bg-black/50 rounded-full overflow-hidden mb-2">
                    <div id="progBar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-600 transition-all duration-500" style="width: 10%;"></div>
                </div>
                <div class="flex justify-between items-center text-xs mb-4">
                    <span id="progLabel" class="text-gray-400">Payment Verification</span>
                    <span id="progPercent" class="font-bold text-white">10%</span>
                </div>
                
                <!-- Working Hours Timer -->
                <div id="workingHoursTimer" class="mt-6 p-4 bg-gradient-to-r from-purple-500/20 to-indigo-500/20 rounded-xl border border-purple-500/30">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs text-gray-400 mb-1">Time Remaining (Working Hours)</p>
                            <p class="text-2xl font-bold" id="timerDisplay">--:--:--</p>
                            <p class="text-xs text-gray-500 mt-1" id="timerStatus">Calculating...</p>
                        </div>
                        <i class="fas fa-clock text-4xl text-purple-400 opacity-50"></i>
                    </div>
                </div>
            </div>

            <!-- Contact Designer -->
            <div class="flex justify-center mb-6">
                <a id="whatsappDesigner" href="https://wa.me/919876543210?text=Hello, I need help with my project" target="_blank" class="flex items-center gap-2 bg-green-500/20 border border-green-500 text-green-400 px-6 py-3 rounded-full font-bold hover:bg-green-500/30 transition">
                    <i class="fab fa-whatsapp text-xl"></i> Contact Your Designer
                </a>
            </div>

            <!-- Client Orders -->
            <h2 class="text-2xl font-bold mb-6">My Orders</h2>
            <div id="clientOrdersContainer" class="space-y-4">
                <!-- JS Injected -->
            </div>
        </div>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- View Order Modal -->
    <div id="viewModal" class="modal-overlay">
        <div class="glass max-w-3xl w-full mx-4 p-8 rounded-2xl relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeViewModal()" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-white">&times;</button>
            
            <h2 class="text-2xl font-bold mb-6">Order Details</h2>
            
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div><strong class="text-gray-400">Order #:</strong> <span id="vId"></span></div>
                <div><strong class="text-gray-400">Client:</strong> <span id="vClient"></span></div>
                <div><strong class="text-gray-400">Contact:</strong> <a id="vWa" target="_blank" class="text-indigo-400 hover:underline"><span id="vContact"></span></a></div>
                <div><strong class="text-gray-400">Brand:</strong> <span id="vBrand"></span></div>
                <div><strong class="text-gray-400">Tagline:</strong> <span id="vTagline"></span></div>
                <div><strong class="text-gray-400">Niche:</strong> <span id="vNiche"></span></div>
                <div><strong class="text-gray-400">Audience:</strong> <span id="vAudience"></span></div>
                <div><strong class="text-gray-400">Colors:</strong> <span id="vColors"></span></div>
                <div><strong class="text-gray-400">Vibe:</strong> <span id="vVibe"></span></div>
                <div><strong class="text-gray-400">Package:</strong> <span id="vPackage"></span></div>
                <div class="col-span-2"><strong class="text-gray-400">Add-ons:</strong> <span id="vAddons" class="text-white"></span></div>
                <div class="col-span-2"><strong class="text-gray-400">Delivery:</strong> <span id="vDelivery"></span></div>
                <div class="col-span-2"><strong class="text-gray-400">Ideas/Notes:</strong> <p class="mt-1 bg-white/5 p-2 rounded" id="vNotes"></p></div>
                <div class="col-span-2"><strong class="text-gray-400">TX ID:</strong> <code class="bg-black/50 px-2 py-1 rounded" id="vTx"></code></div>
                <div><strong class="text-gray-400">Payment:</strong> <span id="vPayStatus"></span></div>
                <div><strong class="text-gray-400">Status:</strong> <span id="vStatus"></span></div>
            </div>

            <input type="hidden" id="vIndex">
            <input type="hidden" id="vOrderId">

            <!-- ADMIN CONTROLS -->
            <div class="mt-6 space-y-3 border-t border-gray-700 pt-6">
                <button id="verifyBtn" onclick="confirmOrderByAdmin()" class="w-full bg-green-600 py-3 rounded-lg font-bold hidden">‚úì Verify Payment & Start Project</button>
                
                <div class="flex gap-3">
                    <select id="updateStatusSelect" class="flex-1 bg-black/50 border border-gray-700 rounded-lg p-3">
                        <option value="Unconfirmed">Unconfirmed</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Sent for Approval">Sent for Approval</option>
                        <option value="Completed">Completed</option>
                    </select>
                    <button onclick="saveAdminChanges()" class="bg-indigo-600 px-6 py-3 rounded-lg font-bold">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="glass max-w-md w-full mx-4 p-8 rounded-2xl relative">
            <button onclick="toggleSettingsModal()" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-white">&times;</button>
            <h2 class="text-2xl font-bold mb-6">‚öôÔ∏è Settings</h2>
            
            <div class="space-y-4">
                <h4 class="text-sm font-bold text-gray-400 uppercase">Theme Color</h4>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="setTheme('default')" class="py-3 rounded-lg bg-indigo-500 text-white font-bold">Indigo</button>
                    <button onclick="setTheme('pink')" class="py-3 rounded-lg bg-pink-500 text-white font-bold">Pink</button>
                    <button onclick="setTheme('blue')" class="py-3 rounded-lg bg-blue-500 text-white font-bold">Blue</button>
                    <button onclick="setTheme('green')" class="py-3 rounded-lg bg-green-500 text-white font-bold">Green</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://xwqitpteemdvrycpcxgo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh3cWl0cHRlZW1kdnJ5Y3BjeGdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3MDAzMDgsImV4cCI6MjA4NTI3NjMwOH0.ZEn9riWkZn-WW0wtH01AiujJH5EJmfps90oHVsRVeBI';

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let currentViewMode = 'grid';
        let allOrders = [];
        let flashMessages = [
            "Please be patient while we create your perfect design. Our working hours are 10 AM - 6 PM (Monday-Friday). We'll notify you once your design is ready!",
            "Avoid sending multiple messages. We're working on your logo and will reach out once it's complete.",
            "Working hours: 10 AM - 6 PM, Monday to Friday. Weekend orders will be processed on Monday.",
            "Quality takes time! We'll deliver your design within the promised timeline. Thank you for your patience.",
            "Our designers are crafting something amazing for you. We'll contact you as soon as it's ready!"
        ];
        let currentFlashIndex = 0;

        // ============================================
        // PACKAGE PRICING
        // ============================================
        const PACKAGE_PRICES = {
            'Basic': 99,
            'Standard': 150,
            'Premium': 200
        };

        const ADDON_PRICES = {
            'Social Media Kit': 100,
            'Visiting Card': 50,
            'Express Delivery (5 Hours)': 100,
            'Express': 100
        };

        // ============================================
        // WORKING HOURS CALCULATOR
        // ============================================
        function isWorkingHour(date) {
            const day = date.getDay(); // 0 = Sunday, 6 = Saturday
            const hour = date.getHours();
            
            // Monday to Friday (1-5), 10 AM to 6 PM
            return day >= 1 && day <= 5 && hour >= 10 && hour < 18;
        }

        function calculateWorkingHoursRemaining(startTimestamp, totalWorkingHours) {
            const start = new Date(startTimestamp);
            const now = new Date();
            
            let workingHoursElapsed = 0;
            let currentTime = new Date(start);
            
            // Calculate elapsed working hours
            while (currentTime < now) {
                if (isWorkingHour(currentTime)) {
                    workingHoursElapsed += 1;
                }
                currentTime = new Date(currentTime.getTime() + 60 * 60 * 1000); // Add 1 hour
            }
            
            const remaining = Math.max(0, totalWorkingHours - workingHoursElapsed);
            return { remaining, elapsed: workingHoursElapsed };
        }

        function formatTime(hours) {
            const days = Math.floor(hours / 8);
            const remainingHours = Math.floor(hours % 8);
            const minutes = Math.floor((hours % 1) * 60);
            
            if (days > 0) {
                return `${days}d ${remainingHours}h ${minutes}m`;
            }
            return `${remainingHours}h ${minutes}m`;
        }

        // ============================================
        // CALCULATE ORDER PRICE
        // ============================================
        function calculateOrderPrice(order) {
            let price = PACKAGE_PRICES[order.package_type] || 0;
            
            if (order.addons && order.addons !== 'None') {
                const addons = order.addons.split(',').map(a => a.trim());
                addons.forEach(addon => {
                    // Check for express
                    if (addon.toLowerCase().includes('express')) {
                        price += ADDON_PRICES['Express'];
                    }
                    // Check for social media kit
                    else if (addon.toLowerCase().includes('social')) {
                        price += ADDON_PRICES['Social Media Kit'];
                    }
                    // Check for visiting card
                    else if (addon.toLowerCase().includes('visiting') || addon.toLowerCase().includes('card')) {
                        price += ADDON_PRICES['Visiting Card'];
                    }
                });
            }
            
            return price;
        }

        // ============================================
        // LOAD DASHBOARD
        // ============================================
        async function loadDashboard() {
            const userStr = localStorage.getItem('currentUser');
            if (!userStr) {
                window.location.href = 'login.html';
                return;
            }

            const user = JSON.parse(userStr);
            document.getElementById('userDisplay').innerText = user.name || user.email;

            if (user.role === 'admin') {
                document.getElementById('adminView').classList.remove('hidden');
                await loadAdminOrders();
            } else {
                document.getElementById('clientView').classList.remove('hidden');
                await renderClientOrders(user.email);
                startFlashMessages();
            }
        }

        // ============================================
        // FLASH MESSAGES FOR CLIENTS
        // ============================================
        function startFlashMessages() {
            setInterval(() => {
                currentFlashIndex = (currentFlashIndex + 1) % flashMessages.length;
                const msgEl = document.getElementById('flashMessage');
                if (msgEl) {
                    msgEl.style.opacity = '0';
                    setTimeout(() => {
                        msgEl.textContent = flashMessages[currentFlashIndex];
                        msgEl.style.opacity = '1';
                    }, 300);
                }
            }, 8000);
        }

        // ============================================
        // LOAD ADMIN ORDERS
        // ============================================
        async function loadAdminOrders() {
            try {
                const { data: orders, error } = await supabaseClient
                    .from('orders')
                    .select('*')
                    .order('timestamp', { ascending: false });

                if (error) {
                    console.error('Error fetching orders:', error);
                    alert('Error loading orders from database');
                    return;
                }

                allOrders = orders || [];
                console.log('Loaded orders:', allOrders);

                // Calculate stats
                const total = allOrders.length;
                const pending = allOrders.filter(o => o.status === 'In Progress').length;
                const unpaid = allOrders.filter(o => o.status === 'Unconfirmed').length;
                
                // Calculate total earnings
                const earnings = allOrders.reduce((sum, order) => {
                    return sum + calculateOrderPrice(order);
                }, 0);

                document.getElementById('stat-total').innerText = total;
                document.getElementById('stat-pending').innerText = pending;
                document.getElementById('stat-unpaid').innerText = unpaid;
                document.getElementById('totalEarnings').innerText = '‚Çπ' + earnings.toLocaleString();

                // Render orders
                renderOrders();
                renderPriorityQueue();
            } catch (error) {
                console.error('Error in loadAdminOrders:', error);
                alert('Error loading dashboard');
            }
        }

        // ============================================
        // PRIORITY QUEUE (ISSUE #4 FIX)
        // ============================================
        function renderPriorityQueue() {
            const now = new Date();
            
            // Filter active orders (Unconfirmed or In Progress)
            const activeOrders = allOrders.filter(o => 
                o.status === 'Unconfirmed' || o.status === 'In Progress'
            );

            // Sort by priority:
            // 1. Express orders first
            // 2. Then by time remaining (oldest first)
            const priorityOrders = activeOrders.sort((a, b) => {
                const aIsExpress = a.addons && a.addons.toLowerCase().includes('express');
                const bIsExpress = b.addons && b.addons.toLowerCase().includes('express');
                
                // Express orders go first
                if (aIsExpress && !bIsExpress) return -1;
                if (!aIsExpress && bIsExpress) return 1;
                
                // Then sort by timestamp (oldest first)
                return a.timestamp - b.timestamp;
            }).slice(0, 5);

            const container = document.getElementById('priorityList');
            
            if (priorityOrders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No urgent orders</p>';
                return;
            }

            container.innerHTML = priorityOrders.map((o, idx) => {
                const isExpress = o.addons && o.addons.toLowerCase().includes('express');
                const workingHours = isExpress ? 5 : 48;
                const { remaining } = calculateWorkingHoursRemaining(o.timestamp, workingHours);
                
                return `
                    <div class="glass p-3 rounded-xl border-l-4 ${o.status === 'Unconfirmed' ? 'border-red-500' : 'border-yellow-500'} ${isExpress ? 'express-badge' : ''} relative">
                        ${isExpress ? '<div class="absolute top-2 right-2"><i class="fas fa-bolt text-yellow-300 text-xs"></i></div>' : ''}
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-bold text-sm">${o.brand_name}</h4>
                                <p class="text-xs text-gray-500">${o.client_name}</p>
                                <p class="text-xs text-gray-400 mt-1">${formatTime(remaining)} left</p>
                            </div>
                            <span class="text-xs px-2 py-1 bg-white/10 rounded">${o.status === 'Unconfirmed' ? '‚ö†Ô∏è New' : 'üî• Active'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // VIEW MODE SWITCHING (ISSUE #3 FIX)
        // ============================================
        function setViewMode(mode) {
            currentViewMode = mode;
            
            // Update button states
            ['gridBtn', 'listBtn', 'kanbanBtn'].forEach(id => {
                document.getElementById(id).classList.remove('active');
            });
            document.getElementById(mode + 'Btn').classList.add('active');
            
            renderOrders();
        }

        // ============================================
        // RENDER ORDERS (ALL VIEW MODES)
        // ============================================
        function renderOrders() {
            const container = document.getElementById('ordersContainer');
            
            if (allOrders.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-12">No orders yet</div>';
                return;
            }

            if (currentViewMode === 'grid') {
                renderGridView(container);
            } else if (currentViewMode === 'list') {
                renderListView(container);
            } else if (currentViewMode === 'kanban') {
                renderKanbanView(container);
            }
        }

        function renderGridView(container) {
            container.innerHTML = `<div id="ordersGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>`;
            const grid = container.querySelector('#ordersGrid');
            
            grid.innerHTML = allOrders.map((o, idx) => {
                const statusColors = {
                    'Unconfirmed': 'bg-red-500/20 text-red-400 border-red-500',
                    'In Progress': 'bg-yellow-500/20 text-yellow-400 border-yellow-500',
                    'Sent for Approval': 'bg-blue-500/20 text-blue-400 border-blue-500',
                    'Completed': 'bg-green-500/20 text-green-400 border-green-500'
                };

                const isExpress = o.addons && o.addons.toLowerCase().includes('express');

                return `
                    <div class="glass p-5 rounded-xl border border-white/10 hover:border-white/30 transition cursor-pointer relative" onclick="viewOrder(${idx})">
                        ${isExpress ? '<div class="absolute top-3 right-3"><i class="fas fa-bolt text-yellow-400 text-lg"></i></div>' : ''}
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-bold text-lg">${o.brand_name}</h3>
                                <p class="text-xs text-gray-500">${o.order_number}</p>
                            </div>
                            <span class="px-2 py-1 ${statusColors[o.status] || 'bg-gray-500/20 text-gray-400'} border rounded-full text-[10px] font-bold">${o.status}</span>
                        </div>
                        
                        <div class="space-y-1 text-xs text-gray-400 mb-3">
                            <p><i class="fas fa-user w-4"></i> ${o.client_name}</p>
                            <p><i class="fas fa-tag w-4"></i> ${o.package_type}</p>
                            <p><i class="fas fa-calendar w-4"></i> ${o.date}</p>
                        </div>
                        
                        <div class="flex gap-2 mt-3">
                            <a href="https://wa.me/${o.contact.replace(/\D/g,'')}" onclick="event.stopPropagation()" class="flex-1 bg-green-500/20 text-green-400 text-center py-2 rounded-lg text-xs font-bold hover:bg-green-500/30">
                                <i class="fab fa-whatsapp"></i> Chat
                            </a>
                            <button onclick="event.stopPropagation(); viewOrder(${idx})" class="flex-1 bg-indigo-500/20 text-indigo-400 py-2 rounded-lg text-xs font-bold hover:bg-indigo-500/30">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderListView(container) {
            container.innerHTML = '<div id="ordersList" class="space-y-3"></div>';
            const list = container.querySelector('#ordersList');
            
            list.innerHTML = allOrders.map((o, idx) => {
                const isExpress = o.addons && o.addons.toLowerCase().includes('express');
                return `
                    <div class="glass p-4 rounded-xl flex items-center gap-4 hover:border-white/30 border border-white/10 cursor-pointer" onclick="viewOrder(${idx})">
                        ${isExpress ? '<i class="fas fa-bolt text-yellow-400 text-xl"></i>' : '<i class="fas fa-box text-gray-500"></i>'}
                        <div class="flex-1">
                            <h3 class="font-bold">${o.brand_name} <span class="text-xs text-gray-500">${o.order_number}</span></h3>
                            <p class="text-xs text-gray-400">${o.client_name} ‚Ä¢ ${o.package_type} ‚Ä¢ ${o.date}</p>
                        </div>
                        <span class="px-3 py-1 bg-white/10 rounded-full text-xs">${o.status}</span>
                        <button class="px-4 py-2 bg-indigo-500/20 text-indigo-400 rounded-lg text-xs font-bold">View</button>
                    </div>
                `;
            }).join('');
        }

        function renderKanbanView(container) {
            const statuses = ['Unconfirmed', 'In Progress', 'Sent for Approval', 'Completed'];
            
            container.innerHTML = '<div class="kanban-view"></div>';
            const kanban = container.querySelector('.kanban-view');
            
            kanban.innerHTML = statuses.map(status => {
                const statusOrders = allOrders.filter(o => o.status === status);
                return `
                    <div class="kanban-column">
                        <h3 class="font-bold mb-4 text-sm uppercase tracking-wide">${status} (${statusOrders.length})</h3>
                        <div class="space-y-3">
                            ${statusOrders.map((o, idx) => {
                                const globalIdx = allOrders.findIndex(order => order.id === o.id);
                                const isExpress = o.addons && o.addons.toLowerCase().includes('express');
                                return `
                                    <div class="glass p-3 rounded-xl cursor-pointer hover:border-white/30 border border-white/10" onclick="viewOrder(${globalIdx})">
                                        ${isExpress ? '<div class="text-right mb-1"><i class="fas fa-bolt text-yellow-400 text-xs"></i></div>' : ''}
                                        <h4 class="font-bold text-sm">${o.brand_name}</h4>
                                        <p class="text-xs text-gray-500">${o.client_name}</p>
                                        <p class="text-xs text-gray-400 mt-1">${o.package_type}</p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // VIEW ORDER MODAL (ISSUE #1 FIX - SHOW ADDONS)
        // ============================================
        async function viewOrder(index) {
            try {
                const { data: orders, error } = await supabaseClient
                    .from('orders')
                    .select('*')
                    .order('timestamp', { ascending: false });

                if (error) throw error;

                const o = orders[index];
                if (!o) {
                    alert('Order not found');
                    return;
                }

                // Populate modal
                document.getElementById('vId').innerText = o.order_number;
                document.getElementById('vClient').innerText = o.client_name;
                document.getElementById('vContact').innerText = o.contact;
                document.getElementById('vBrand').innerText = o.brand_name;
                document.getElementById('vTagline').innerText = o.tagline || 'N/A';
                document.getElementById('vNiche').innerText = o.niche;
                document.getElementById('vAudience').innerText = o.audience || 'N/A';
                document.getElementById('vColors').innerText = o.colors || 'N/A';
                document.getElementById('vVibe').innerText = o.vibe;
                document.getElementById('vPackage').innerText = o.package_type;
                
                // FIX #1: Display add-ons properly
                const addonsText = o.addons && o.addons !== 'None' ? o.addons : 'None selected';
                document.getElementById('vAddons').innerText = addonsText;
                
                // Calculate delivery info
                const isExpress = o.addons && o.addons.toLowerCase().includes('express');
                const workingHours = isExpress ? 5 : 48;
                
                let deliveryText = isExpress ? '‚ö° 5 Working Hours (Express)' : '48 Working Hours';
                
                if (o.timestamp && o.status !== 'Unconfirmed') {
                    const { remaining } = calculateWorkingHoursRemaining(o.timestamp, workingHours);
                    
                    if (remaining > 0 && o.status !== 'Completed') {
                        deliveryText += ` | ‚è±Ô∏è ${formatTime(remaining)} remaining`;
                    } else if (o.status === 'Completed') {
                        deliveryText += ' | ‚úÖ Delivered';
                    }
                }
                
                document.getElementById('vDelivery').innerText = deliveryText;
                document.getElementById('vNotes').innerText = o.ideas || 'None';
                document.getElementById('vTx').innerText = o.tx_id;
                document.getElementById('vPayStatus').innerText = o.status === 'Unconfirmed' ? 'Pending Verification' : 'Paid & Verified';
                document.getElementById('vStatus').innerText = o.status;
                document.getElementById('vIndex').value = index;
                document.getElementById('vOrderId').value = o.id;
                document.getElementById('vWa').href = `https://wa.me/${o.contact.replace(/\D/g,'')}`;

                // Admin Verification Gate
                const vBtn = document.getElementById('verifyBtn');
                if (o.status === 'Unconfirmed') {
                    vBtn.classList.remove('hidden');
                } else {
                    vBtn.classList.add('hidden');
                }

                document.getElementById('updateStatusSelect').value = o.status;
                document.getElementById('viewModal').classList.add('active');
            } catch (error) {
                console.error('Error viewing order:', error);
                alert('Error loading order details');
            }
        }

        async function confirmOrderByAdmin() {
            const orderId = document.getElementById('vOrderId').value;
            
            try {
                const { data, error } = await supabaseClient
                    .from('orders')
                    .update({ status: 'In Progress' })
                    .eq('id', orderId)
                    .select();

                if (error) throw error;

                alert('Order Verified! Client can now see progress.');
                location.reload();
            } catch (error) {
                console.error('Error verifying order:', error);
                alert('Error updating order: ' + error.message);
            }
        }

        async function saveAdminChanges() {
            const orderId = document.getElementById('vOrderId').value;
            const newStatus = document.getElementById('updateStatusSelect').value;
            
            try {
                const { data, error } = await supabaseClient
                    .from('orders')
                    .update({ status: newStatus })
                    .eq('id', orderId)
                    .select();

                if (error) throw error;

                alert('Status Updated');
                location.reload();
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Error updating order: ' + error.message);
            }
        }

        // ============================================
        // CLIENT DASHBOARD (ISSUE #6 & #7 FIX)
        // ============================================
        async function renderClientOrders(email) {
            try {
                const { data: orders, error } = await supabaseClient
                    .from('orders')
                    .select('*')
                    .eq('user_email', email)
                    .order('timestamp', { ascending: false });

                if (error) {
                    console.error('Error fetching client orders:', error);
                    return;
                }

                const container = document.getElementById('clientOrdersContainer');
                
                if (orders.length > 0) {
                    const active = orders[0];
                    document.getElementById('whatsappDesigner').href = `https://wa.me/919876543210?text=Hello, I need help with my project ${active.order_number}`;
                    
                    // Progress Bar Logic
                    const progressBox = document.getElementById('clientProgress');
                    progressBox.classList.remove('hidden');
                    
                    let percent = 10; 
                    let label = "Payment Verification";
                    if (active.status === 'In Progress') { 
                        percent = 45; 
                        label = "Designer is creating your concepts"; 
                    }
                    if (active.status === 'Sent for Approval') { 
                        percent = 80; 
                        label = "Concepts sent! Check WhatsApp/Email"; 
                    }
                    if (active.status === 'Completed') { 
                        percent = 100; 
                        label = "Project Finished!"; 
                    }
                    
                    document.getElementById('progBar').style.width = percent + '%';
                    document.getElementById('progPercent').innerText = percent + '%';
                    document.getElementById('progLabel').innerText = label;

                    // FIX #7: Working Hours Timer
                    if (active.status !== 'Unconfirmed' && active.status !== 'Completed') {
                        startWorkingHoursTimer(active);
                    }
                }

                if (orders.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-400 py-12">No orders yet</div>';
                    return;
                }

                container.innerHTML = orders.map((o, idx) => `
                    <div class="glass p-6 rounded-2xl border border-white/10 relative overflow-hidden">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold">${o.brand_name} <span class="text-xs text-gray-500 font-normal">${o.order_number}</span></h3>
                                <p class="text-xs text-gray-400">Targeting: ${o.audience || 'General'}</p>
                            </div>
                            <span class="px-3 py-1 bg-indigo-500/20 text-indigo-400 rounded-full text-[10px] font-bold uppercase tracking-widest">${o.status}</span>
                        </div>
                        
                        ${o.status === 'Unconfirmed' ? `
                            <div class="bg-red-500/10 border border-red-500/30 p-4 rounded-xl text-center">
                                <p class="text-xs text-red-400 font-bold">Waiting for designer to verify payment ID: ${o.tx_id}</p>
                            </div>
                        ` : `
                            <div class="grid grid-cols-2 gap-2">
                                 <div class="bg-white/5 p-3 rounded-xl text-center">
                                    <p class="text-[10px] text-gray-500 uppercase">Package</p>
                                    <p class="text-sm font-bold">${o.package_type || 'Standard'}</p>
                                 </div>
                                 <div class="bg-white/5 p-3 rounded-xl text-center">
                                    <p class="text-[10px] text-gray-500 uppercase">Delivery</p>
                                    <p class="text-sm font-bold">${o.addons && o.addons.toLowerCase().includes('express') ? '‚ö° 5 Hours' : '48 Hours'}</p>
                                 </div>
                                 ${o.addons && o.addons !== 'None' ? `
                                 <div class="bg-white/5 p-3 rounded-xl col-span-2">
                                    <p class="text-[10px] text-gray-500 uppercase">Add-ons</p>
                                    <p class="text-xs font-bold">${o.addons}</p>
                                 </div>
                                 ` : ''}
                            </div>
                        `}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error in renderClientOrders:', error);
            }
        }

        // FIX #7: Working Hours Timer
        function startWorkingHoursTimer(order) {
            const isExpress = order.addons && order.addons.toLowerCase().includes('express');
            const totalHours = isExpress ? 5 : 48;
            
            function updateTimer() {
                const now = new Date();
                const { remaining } = calculateWorkingHoursRemaining(order.timestamp, totalHours);
                
                const timerDisplay = document.getElementById('timerDisplay');
                const timerStatus = document.getElementById('timerStatus');
                
                if (timerDisplay) {
                    timerDisplay.textContent = formatTime(remaining);
                    
                    if (isWorkingHour(now)) {
                        timerStatus.textContent = 'üü¢ Working hours - Timer active';
                        timerStatus.className = 'text-xs text-green-400 mt-1';
                    } else {
                        timerStatus.textContent = 'üî¥ Outside working hours - Timer paused (Mon-Fri, 10AM-6PM)';
                        timerStatus.className = 'text-xs text-red-400 mt-1';
                    }
                }
            }
            
            updateTimer();
            setInterval(updateTimer, 60000); // Update every minute
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        }

        function closeViewModal() { document.getElementById('viewModal').classList.remove('active'); }
        function toggleSettingsModal() { document.getElementById('settingsModal').classList.toggle('active'); }
        function setTheme(theme) { 
            document.body.classList.remove('theme-pink', 'theme-blue', 'theme-green');
            if (theme !== 'default') document.body.classList.add('theme-' + theme);
            toggleSettingsModal();
        }
        
        function addStickyNote() {
            const container = document.getElementById('stickyNotesContainer');
            const note = document.createElement('textarea');
            note.className = "w-full bg-yellow-500/10 border border-yellow-500/30 rounded p-2 text-xs text-yellow-100 placeholder-yellow-200/50 resize-none";
            note.rows = 2; 
            note.placeholder = "New note...";
            container.prepend(note);
        }

        function printInvoice() {
            alert("Print invoice feature - to be implemented");
        }

        // Initialize
        loadDashboard();
    </script>
</body>
</html>
